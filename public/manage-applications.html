<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beige | Manage Applications</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#faf6f0',
                            100: '#f5ede1',
                            200: '#ebdbc3',
                            300: '#dfc39d',
                            400: '#d2a16d',
                            500: '#c8854a',
                            600: '#ba6f3f',
                            700: '#9b5835',
                            800: '#7d4730',
                            900: '#663b29',
                            950: '#361e15',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .sidebar {
            transition: width 0.3s ease, box-shadow 0.3s ease;
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 1px 0 10px rgba(0, 0, 0, 0.05);
        }
        .sidebar-collapsed {
            width: 60px;
        }
        .sidebar-collapsed .sidebar-text {
            display: none;
        }
        .sidebar-collapsed .logo-text {
            display: none;
        }
        .sidebar-collapsed .nav-item {
            justify-content: center;
        }
        .content-area {
            transition: margin-left 0.3s ease;
            background-color: #f8fafc;
        }
        .content-expanded {
            margin-left: 60px;
        }
        .card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: cardEnter 0.4s ease-out forwards;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        @keyframes cardEnter {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .modal {
            transition: opacity 0.2s ease, transform 0.2s ease;
            backdrop-filter: blur(2px);
        }
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
        }
        .alert {
            animation: slideIn 0.3s ease-out;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .form-input {
            border: 1px solid #e2e8f0;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            width: 100%;
            font-size: 0.8125rem;
            background-color: #fff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .form-input:focus {
            border-color: #c8854a;
            box-shadow: 0 0 0 3px rgba(200, 133, 74, 0.15);
            background-color: #faf6f0;
        }
        .form-select {
            border: 1px solid #e2e8f0;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            width: 100%;
            font-size: 0.8125rem;
            background-color: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
        }
        .form-select:focus {
            border-color: #c8854a;
            box-shadow: 0 0 0 3px rgba(200, 133, 74, 0.15);
            background-color: #faf6f0;
        }
        .form-button {
            background-color: #c8854a;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .form-button:hover {
            background-color: #ba6f3f;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(200, 133, 74, 0.3);
        }
        .form-button:disabled {
            background-color: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .spinner {
            width: 0.875rem;
            height: 0.875rem;
            border: 2px solid #c8854a;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .tooltip {
            position: relative;
        }
        .tooltip:hover:after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1e293b;
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 500;
            white-space: nowrap;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            margin-bottom: 6px;
        }
        header {
            background: linear-gradient(90deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.05);
        }
        .nav-item {
            border-radius: 6px;
            margin: 0 6px;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
        }
        .nav-item:hover {
            transform: translateX(3px);
        }
        .nav-item.active {
            background-color: #faf6f0;
            color: #c8854a;
            font-weight: 600;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        .badge-pending {
            background-color: #fef3c7;
            color: #d97706;
        }
        .badge-reviewed {
            background-color: #dbeafe;
            color: #2563eb;
        }
        .badge-accepted {
            background-color: #d1fae5;
            color: #059669;
        }
        .badge-rejected {
            background-color: #fee2e2;
            color: #dc2626;
        }
        .badge-merged {
            background-color: #e0e7ff;
            color: #4f46e5;
        }
        .badge-date {
            background-color: #f5f3ff;
            color: #7c3aed;
            border: 1px solid #ddd6fe;
        }
        .photo-thumbnail {
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .photo-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .carousel-container {
            position: relative;
            width: 100%;
            overflow: hidden;
        }
        .carousel-slide {
            display: flex;
            transition: transform 0.3s ease-in-out;
        }
        .carousel-image {
            width: 100%;
            max-height: 70vh;
            object-fit: contain;
            flex-shrink: 0;
        }
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .carousel-nav:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .carousel-prev {
            left: 1rem;
        }
        .carousel-next {
            right: 1rem;
        }
        .carousel-counter {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
        }
        .lazy-photo {
            background-color: #f3f4f6;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .name-break {
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .image-preloader {
            display: none;
        }
        .date-display {
            background-color: #f8fafc;
            border-radius: 4px;
            padding: 3px 6px;
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Sidebar -->
    <div class="sidebar fixed top-0 left-0 h-screen bg-white shadow-md z-50 w-56 flex flex-col">
        <div class="p-3 flex items-center justify-between border-b border-gray-200">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-primary-500 flex items-center justify-center text-white font-bold text-sm">
                    B
                </div>
                <span class="logo-text ml-2 text-lg font-semibold">Beige Admin</span>
            </div>
            <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700" aria-label="Toggle Sidebar">
                <i class="fas fa-bars text-sm"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto py-3">
            <nav>
                <div class="px-3 mb-3">
                    <p class="sidebar-text text-xs font-semibold text-gray-500 uppercase tracking-wider">Dashboard</p>
                </div>
                <ul>
                    <li>
                        <a href="admin.html" data-section="overview-section" class="nav-item flex items-center px-3 py-2 text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-tachometer-alt w-5 text-center"></i>
                            <span class="sidebar-text ml-2 text-sm">Overview</span>
                        </a>
                    </li>
                    <li>
                        <a href="manage-models.html" data-section="models-section" class="nav-item flex items-center px-3 py-2 text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-users w-5 text-center"></i>
                            <span class="sidebar-text ml-2 text-sm">Models</span>
                        </a>
                    </li>
                    <li>
                        <a href="manage-bookings.html" data-section="bookings-section" class="nav-item flex items-center px-3 py-2 text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-calendar-check w-5 text-center"></i>
                            <span class="sidebar-text ml-2 text-sm">Bookings</span>
                        </a>
                    </li>
                    <li>
                        <a href="manage-applications.html" data-section="applications-section" class="nav-item flex items-center px-3 py-2 text-gray-700 bg-primary-50 text-primary-600 active">
                            <i class="fas fa-envelope w-5 text-center"></i>
                            <span class="sidebar-text ml-2 text-sm">Applications</span>
                        </a>
                    </li>
                </ul>
                <div class="px-3 mt-4 mb-3">
                    <p class="sidebar-text text-xs font-semibold text-gray-500 uppercase tracking-wider">Content</p>
                </div>
                <ul>
                     <li>
                        <a href="manage-about-companies.html" data-section="team-section" class="nav-item flex items-center px-3 py-2 text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-user-tie w-5 text-center"></i>
                            <span class="sidebar-text ml-2 text-sm">About & Companies</span>
                        </a>
                    </li>
                  
                    <li>
                        <a href="manage-team-members.html" data-section="team-section" class="nav-item flex items-center px-3 py-2 text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-user-tie w-5 text-center"></i>
                            <span class="sidebar-text ml-2 text-sm">Team</span>
                        </a>
                    </li>
                    <li>
                        <a href="manage-newsletter-subscribers.html" data-section="newsletter-section" class="nav-item flex items-center px-3 py-2 text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors">
                            <i class="fas fa-newspaper w-5 text-center"></i>
                            <span class="sidebar-text ml-2 text-sm">Newsletter</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        <div class="p-3 border-t border-gray-200 flex items-center">
            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                <i class="fas fa-user text-gray-500 text-sm"></i>
            </div>
            <div class="sidebar-text ml-2">
                <p class="text-sm font-medium">Admin User</p>
                <p class="text-xs text-gray-500">Super Admin</p>
            </div>
            <button id="logout-btn" class="sidebar-text ml-auto text-gray-500 hover:text-gray-700" aria-label="Logout">
                <i class="fas fa-sign-out-alt text-sm"></i>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-area ml-56 min-h-screen">
        <!-- Top Navigation -->
        <header class="bg-white shadow-sm py-3 px-4 flex items-center justify-between sticky top-0 z-40">
            <div class="flex items-center">
                <h1 class="text-lg font-bold text-gray-900" id="dashboard-title">Manage Applications</h1>
            </div>
            <div class="flex items-center space-x-3">
                <button class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors" aria-label="Notifications">
                    <i class="fas fa-bell text-sm"></i>
                </button>
                <button class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors" aria-label="Messages">
                    <i class="fas fa-envelope text-sm"></i>
                </button>
                <div class="relative">
                    <button id="user-menu-button" class="flex items-center space-x-1 focus:outline-none" aria-label="User Menu">
                        <div class="w-6 h-6 rounded-full bg-primary-500 flex items-center justify-center text-white font-medium text-xs">
                            A
                        </div>
                        <span class="hidden md:inline-block text-sm font-medium">Admin User</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="user-menu" class="hidden absolute right-0 mt-1 w-40 bg-white rounded-lg shadow-lg py-1 z-50">
                        <a href="#" class="block px-3 py-1.5 text-xs text-gray-700 hover:bg-gray-50 hover:text-primary-600 transition-colors">Your Profile</a>
                        <a href="#" class="block px-3 py-1.5 text-xs text-gray-700 hover:bg-gray-50 hover:text-primary-600 transition-colors">Settings</a>
                        <a href="#" id="menu-logout" class="block px-3 py-1.5 text-xs text-gray-700 hover:bg-gray-50 hover:text-primary-600 transition-colors">Sign out</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard Content -->
        <main class="p-4">
            <div id="dashboard">
                <!-- Applications Section -->
                <div id="applications-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-base font-semibold text-gray-900">Applications</h2>
                        <div class="flex items-center space-x-2">
                            <div class="relative">
                                <select id="merge-option" class="form-select text-xs" aria-label="Merge Option">
                                    <option value="email">Merge by Email</option>
                                    <option value="name">Merge by Name</option>
                                    <option value="none">Don't Merge</option>
                                </select>
                            </div>
                            <input type="text" id="search-applications" class="form-input text-xs" placeholder="Search applications..." aria-label="Search applications">
                            <button class="form-button text-xs" onclick="loadApplications()" aria-label="Refresh Applications">
                                <i class="fas fa-sync-alt mr-1"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div id="application-loading" class="text-center text-xs py-3 hidden">
                        <span class="spinner"></span> Loading...
                    </div>
                    <p id="application-error" class="text-red-500 text-xs py-2 hidden"></p>
                    <div id="application-stats" class="mb-4 flex space-x-2">
                        <div class="bg-white rounded-lg shadow-sm p-3 text-xs">
                            <span class="font-medium">Total Applications:</span> <span id="total-apps">0</span>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-3 text-xs">
                            <span class="font-medium">Merged Groups:</span> <span id="merged-groups">0</span>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-3 text-xs">
                            <span class="font-medium">Duplicates Found:</span> <span id="duplicates-count">0</span>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-3 text-xs">
                            <span class="font-medium">Recent (7 days):</span> <span id="recent-apps">0</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="application-grid"></div>
                    <div id="pagination-controls" class="mt-6 flex justify-center items-center space-x-2 hidden">
                        <button id="prev-page" class="form-button text-xs" disabled>
                            <i class="fas fa-chevron-left mr-1"></i> Previous
                        </button>
                        <span class="text-xs text-gray-600" id="page-info">Page 1 of 1</span>
                        <button id="next-page" class="form-button text-xs" disabled>
                            Next <i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Success Alert -->
    <div id="success-alert" class="fixed top-3 right-3 z-50 hidden">
        <div class="bg-green-50 border-l-4 border-green-500 p-3">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-check-circle text-green-500 text-sm"></i>
                </div>
                <div class="ml-2">
                    <p id="success-message" class="text-xs font-medium text-green-700">Action completed successfully!</p>
                </div>
                <div class="ml-auto pl-2">
                    <button id="close-success-alert" class="text-green-500 hover:text-green-700" aria-label="Close Success Alert">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Alert -->
    <div id="error-alert" class="fixed top-3 right-3 z-50 hidden">
        <div class="bg-red-50 border-l-4 border-red-500 p-3">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-circle text-red-500 text-sm"></i>
                </div>
                <div class="ml-2">
                    <p id="error-message" class="text-xs font-medium text-red-700">An error occurred.</p>
                </div>
                <div class="ml-auto pl-2">
                    <button id="close-error-alert" class="text-red-500 hover:text-red-700" aria-label="Close Error Alert">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-4">
                <div class="flex items-center justify-center w-10 h-10 mx-auto bg-red-100 rounded-full">
                    <i class="fas fa-exclamation text-red-600 text-base"></i>
                </div>
                <div class="mt-2 text-center sm:mt-3">
                    <h3 id="confirmation-title" class="text-base font-semibold text-gray-900">Confirm Action</h3>
                    <div class="mt-1">
                        <p id="confirmation-message" class="text-xs text-gray-500">Are you sure you want to perform this action?</p>
                    </div>
                </div>
            </div>
            <div class="px-4 py-3 sm:flex sm:flex-row-reverse bg-gray-50 rounded-b-lg">
                <button id="confirm-action" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-3 py-1.5 bg-red-600 text-xs font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-2 sm:w-auto">
                    <span class="confirm-text">Confirm</span>
                    <span class="spinner hidden ml-2"></span>
                </button>
                <button id="cancel-action" type="button" class="mt-2 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-3 py-1.5 bg-white text-xs font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-2 sm:w-auto">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photo-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full">
            <div class="p-4 flex justify-between items-center border-b border-gray-200">
                <h3 class="text-base font-semibold text-gray-900">Application Photos</h3>
                <button id="close-photo-modal" class="text-gray-500 hover:text-gray-700" aria-label="Close Photo Modal">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="carousel-container">
                    <div id="carousel-slide" class="carousel-slide"></div>
                    <button id="carousel-prev" class="carousel-nav carousel-prev hidden" aria-label="Previous Photo">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button id="carousel-next" class="carousel-nav carousel-next hidden" aria-label="Next Photo">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <div id="carousel-counter" class="carousel-counter"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preloader (hidden) -->
    <div class="image-preloader">
        <img id="preload-image" style="display: none;">
    </div>

   <script>
    // State management
    let applicationsData = [];
    let groupedApplicationsData = {};
    let currentPage = 1;
    let itemsPerPage = 20;
    let totalPages = 1;
    let touchStartHandler = null;
    let touchEndHandler = null;
    let searchTimeout = null;
    let photoModalObserver = null;
    let imageCache = new Map();
    
    // Image loading configuration
    const IMAGE_CONFIG = {
        MAX_RETRIES: 2,
        RETRY_DELAY: 1000,
        LOAD_TIMEOUT: 10000,
        THUMBNAIL_SIZE: '200x200',
        PLACEHOLDER_COLOR: '#f3f4f6',
        PLACEHOLDER_TEXT: 'Loading...'
    };
    
    // Store loading promises to prevent duplicate loads
    const imageLoadPromises = new Map();
    
    function decodeToken(token) {
        if (!token) {
            console.error('No token provided for decoding');
            return false;
        }
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const exp = payload.exp * 1000;
            const now = Date.now();
            return exp > now;
        } catch (error) {
            console.error('Error decoding token:', error);
            return false;
        }
    }

    const token = localStorage.getItem('token');
    const dashboard = document.getElementById('dashboard');
    const applicationError = document.getElementById('application-error');
    const applicationLoading = document.getElementById('application-loading');
    const sidebar = document.querySelector('.sidebar');
    const contentArea = document.querySelector('.content-area');
    const userMenuButton = document.getElementById('user-menu-button');
    const userMenu = document.getElementById('user-menu');
    const mergeOption = document.getElementById('merge-option');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageInfo = document.getElementById('page-info');
    const paginationControls = document.getElementById('pagination-controls');

    // Initial token check
    if (!token || !decodeToken(token)) {
        console.log('No valid token found, redirecting to login');
        window.location.href = 'admin.html';
    } else {
        console.log('Token is valid');
        dashboard.classList.remove('hidden');
        loadApplications();
    }

    // Sidebar toggle
    document.getElementById('sidebar-toggle').addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-collapsed');
        contentArea.classList.toggle('content-expanded');
    });

    // User menu toggle
    userMenuButton.addEventListener('click', () => {
        userMenu.classList.toggle('hidden');
    });

    // Logout handlers
    document.getElementById('logout-btn').addEventListener('click', () => {
        console.log('Logging out, clearing token');
        localStorage.removeItem('token');
        window.location.href = 'admin.html';
        userMenu.classList.add('hidden');
    });

    document.getElementById('menu-logout').addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Logging out via menu, clearing token');
        localStorage.removeItem('token');
        window.location.href = 'admin.html';
        userMenu.classList.add('hidden');
    });

    // Close alerts
    document.getElementById('close-success-alert').addEventListener('click', () => {
        document.getElementById('success-alert').classList.add('hidden');
    });

    document.getElementById('close-error-alert').addEventListener('click', () => {
        document.getElementById('error-alert').classList.add('hidden');
    });

    // Photo modal close
    document.getElementById('close-photo-modal').addEventListener('click', () => {
        closePhotoModal();
    });

    // Close photo modal on outside click
    document.getElementById('photo-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('photo-modal')) {
            closePhotoModal();
        }
    });

    // Close photo modal on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !document.getElementById('photo-modal').classList.contains('hidden')) {
            closePhotoModal();
        }
    });

    // Pagination controls
    prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderCurrentPage();
        }
    });

    nextPageBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderCurrentPage();
        }
    });

    // Search with debouncing
    document.getElementById('search-applications').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterApplications(e.target.value);
        }, 300);
    });

    // Merge option change
    mergeOption.addEventListener('change', () => {
        currentPage = 1;
        processApplications();
    });

    // Function to format date - UPDATED FORMAT
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'N/A';
            
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Format for recent dates (today, yesterday)
            if (diffDays === 0) {
                // Show time for today
                const hours = date.getHours();
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const formattedHours = hours % 12 || 12;
                return `Today at ${formattedHours}:${minutes} ${ampm}`;
            } else if (diffDays === 1) {
                // Show time for yesterday
                const hours = date.getHours();
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const formattedHours = hours % 12 || 12;
                return `Yesterday at ${formattedHours}:${minutes} ${ampm}`;
            } else if (diffDays < 7) {
                // Show day name and time for this week
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[date.getDay()];
                const hours = date.getHours();
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const formattedHours = hours % 12 || 12;
                return `${dayName} at ${formattedHours}:${minutes} ${ampm}`;
            }
            
            // Format as full date with time for older dates
            const day = date.getDate();
            const month = date.toLocaleDateString('en-US', { month: 'long' });
            const year = date.getFullYear();
            const hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            
            // Return format: "March 15, 2024 at 2:30 PM"
            return `${month} ${day}, ${year} at ${formattedHours}:${minutes} ${ampm}`;
        } catch (error) {
            console.error('Error formatting date:', error);
            return 'N/A';
        }
    }

    // Function to get time ago - UPDATED FORMAT
    function getTimeAgo(dateString) {
        if (!dateString) return '';
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';
            
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffMinutes = Math.floor(diffTime / (1000 * 60));
            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const diffWeeks = Math.floor(diffDays / 7);
            const diffMonths = Math.floor(diffDays / 30);
            const diffYears = Math.floor(diffDays / 365);
            
            if (diffMinutes < 60) {
                return diffMinutes === 1 ? '1 minute ago' : `${diffMinutes} minutes ago`;
            } else if (diffHours < 24) {
                return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
            } else if (diffDays < 7) {
                return diffDays === 1 ? '1 day ago' : `${diffDays} days ago`;
            } else if (diffWeeks < 4) {
                return diffWeeks === 1 ? '1 week ago' : `${diffWeeks} weeks ago`;
            } else if (diffMonths < 12) {
                return diffMonths === 1 ? '1 month ago' : `${diffMonths} months ago`;
            } else {
                return diffYears === 1 ? '1 year ago' : `${diffYears} years ago`;
            }
        } catch (error) {
            return '';
        }
    }

    // Function to get simple date for display (without time)
    function getSimpleDate(dateString) {
        if (!dateString) return 'N/A';
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'N/A';
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}/${month}/${year}`;
        } catch (error) {
            return 'N/A';
        }
    }

    // Function to load image with retry logic and timeout
    function loadImageWithRetry(url, retries = IMAGE_CONFIG.MAX_RETRIES, timeout = IMAGE_CONFIG.LOAD_TIMEOUT) {
        // Return cached promise if exists
        if (imageLoadPromises.has(url)) {
            return imageLoadPromises.get(url);
        }
        
        const loadPromise = new Promise((resolve, reject) => {
            const img = new Image();
            let retryCount = 0;
            
            // Set timeout
            const timeoutId = setTimeout(() => {
                if (retryCount < retries) {
                    retryLoad();
                } else {
                    reject(new Error('Image load timeout'));
                    imageLoadPromises.delete(url);
                }
            }, timeout);
            
            const retryLoad = () => {
                retryCount++;
                clearTimeout(timeoutId);
                
                // Add cache busting query parameter for retry
                const cacheBustUrl = retryCount > 0 ? 
                    `${url}${url.includes('?') ? '&' : '?'}_cb=${Date.now()}` : 
                    url;
                
                img.src = cacheBustUrl;
                
                // Set new timeout
                setTimeout(() => {
                    if (!img.complete && retryCount < retries) {
                        retryLoad();
                    }
                }, timeout);
            };
            
            img.onload = () => {
                clearTimeout(timeoutId);
                imageCache.set(url, img);
                resolve(img);
                imageLoadPromises.delete(url);
            };
            
            img.onerror = () => {
                if (retryCount < retries) {
                    console.log(`Retrying image load (${retryCount + 1}/${retries}): ${url}`);
                    setTimeout(retryLoad, IMAGE_CONFIG.RETRY_DELAY);
                } else {
                    clearTimeout(timeoutId);
                    reject(new Error(`Failed to load image after ${retries} retries`));
                    imageLoadPromises.delete(url);
                }
            };
            
            // Start initial load
            retryLoad();
        });
        
        imageLoadPromises.set(url, loadPromise);
        return loadPromise;
    }
    
    // Function to create image placeholder
    function createImagePlaceholder(index, total) {
        const placeholder = document.createElement('div');
        placeholder.className = 'image-placeholder bg-gray-100 rounded relative overflow-hidden';
        placeholder.style.minHeight = '80px';
        placeholder.innerHTML = `
            <div class="absolute inset-0 flex flex-col items-center justify-center">
                <div class="spinner-small w-6 h-6 border-2 border-primary-300 border-t-primary-600 rounded-full animate-spin mb-2"></div>
                <span class="text-xs text-gray-500">Loading ${index + 1}/${total}</span>
            </div>
        `;
        return placeholder;
    }
    
    // Function to create image error fallback
    function createImageErrorFallback() {
        const fallback = document.createElement('div');
        fallback.className = 'image-fallback bg-gray-100 rounded flex items-center justify-center';
        fallback.style.minHeight = '80px';
        fallback.innerHTML = `
            <div class="text-center">
                <i class="fas fa-image text-gray-300 text-xl mb-1"></i>
                <p class="text-xs text-gray-400">Image failed to load</p>
            </div>
        `;
        return fallback;
    }
    
    // Function to lazy load image into container
    function lazyLoadImage(container, imageUrl, index, totalImages) {
        // Create and insert placeholder
        const placeholder = createImagePlaceholder(index, totalImages);
        container.innerHTML = '';
        container.appendChild(placeholder);
        
        // Load image with retry
        loadImageWithRetry(imageUrl)
            .then(img => {
                // Create image element
                const imageElement = document.createElement('img');
                imageElement.src = img.src;
                imageElement.alt = `Thumbnail ${index + 1}`;
                imageElement.className = 'photo-thumbnail w-full h-20 object-cover rounded transition-opacity duration-300';
                imageElement.style.opacity = '0';
                imageElement.loading = 'lazy';
                
                // Replace placeholder with image
                container.innerHTML = '';
                container.appendChild(imageElement);
                
                // Fade in image
                setTimeout(() => {
                    imageElement.style.opacity = '1';
                }, 50);
                
                // Add click event
                imageElement.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const card = this.closest('.card');
                    const photos = [];
                    const thumbnails = card.querySelectorAll('.photo-thumbnail');
                    const clickedIndex = Array.from(thumbnails).indexOf(this);
                    
                    thumbnails.forEach(thumb => {
                        if (thumb.src) {
                            photos.push(thumb.src);
                        }
                    });
                    
                    if (photos.length > 0 && clickedIndex >= 0) {
                        showPhotoModal(photos, clickedIndex);
                    }
                });
            })
            .catch(error => {
                console.error('Failed to load image:', imageUrl, error);
                // Replace with error fallback
                container.innerHTML = '';
                container.appendChild(createImageErrorFallback());
            });
    }

    // Function to preload images intelligently
    function preloadImages(imageUrls, priority = 'low') {
        if (!Array.isArray(imageUrls) || imageUrls.length === 0) return;
        
        // Limit concurrent loads based on priority
        const maxConcurrent = priority === 'high' ? 4 : 2;
        const queue = [...imageUrls];
        
        const loadNext = () => {
            if (queue.length === 0) return;
            
            const url = queue.shift();
            if (!imageCache.has(url) && !imageLoadPromises.has(url)) {
                loadImageWithRetry(url, 1) // Only 1 retry for preload
                    .catch(() => {}) // Silent fail for preload
                    .finally(loadNext);
            } else {
                loadNext();
            }
        };
        
        // Start loading
        for (let i = 0; i < Math.min(maxConcurrent, imageUrls.length); i++) {
            loadNext();
        }
    }

    function closePhotoModal() {
        const photoModal = document.getElementById('photo-modal');
        
        // Remove touch event listeners to prevent memory leaks
        if (touchStartHandler && touchEndHandler) {
            const carouselSlide = document.getElementById('carousel-slide');
            if (carouselSlide) {
                carouselSlide.removeEventListener('touchstart', touchStartHandler);
                carouselSlide.removeEventListener('touchend', touchEndHandler);
            }
            touchStartHandler = null;
            touchEndHandler = null;
        }
        
        // Clean up lazy loading observer
        if (photoModalObserver) {
            photoModalObserver.disconnect();
            photoModalObserver = null;
        }
        
        // Cancel any pending image loads for modal
        document.querySelectorAll('#carousel-slide img').forEach(img => {
            if (img.src && imageLoadPromises.has(img.src)) {
                // We can't cancel the promise, but we can remove from promises map
                imageLoadPromises.delete(img.src);
            }
        });
        
        photoModal.classList.add('modal-exit-active');
        setTimeout(() => {
            photoModal.classList.add('hidden');
            photoModal.classList.remove('modal-exit-active');
            // Clear carousel content to free memory
            document.getElementById('carousel-slide').innerHTML = '';
        }, 200);
    }

    let currentPhotoIndex = 0;
    let photos = [];

    function showPhotoModal(photoArray, startIndex = 0) {
        if (!Array.isArray(photoArray) || photoArray.length === 0) {
            console.error('Invalid photo array:', photoArray);
            return;
        }
        
        photos = photoArray;
        currentPhotoIndex = Math.min(Math.max(startIndex, 0), photos.length - 1);
        const photoModal = document.getElementById('photo-modal');
        const carouselSlide = document.getElementById('carousel-slide');
        const carouselPrev = document.getElementById('carousel-prev');
        const carouselNext = document.getElementById('carousel-next');
        const carouselCounter = document.getElementById('carousel-counter');

        carouselSlide.innerHTML = '';
        
        // Create loading placeholders for all images
        photos.forEach((url, index) => {
            const slideContainer = document.createElement('div');
            slideContainer.className = 'carousel-slide-item relative w-full flex-shrink-0';
            
            // Create loading overlay
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'absolute inset-0 flex items-center justify-center bg-gray-100';
            loadingOverlay.innerHTML = `
                <div class="text-center">
                    <div class="spinner w-8 h-8 border-4 border-primary-300 border-t-primary-600 rounded-full animate-spin mx-auto mb-2"></div>
                    <p class="text-sm text-gray-600">Loading image ${index + 1}/${photos.length}</p>
                </div>
            `;
            
            // Create image element
            const img = document.createElement('img');
            img.className = 'carousel-image w-full h-full object-contain';
            img.alt = `Application Photo ${index + 1}`;
            img.style.opacity = '0';
            img.loading = 'eager'; // Eager loading for modal images
            
            slideContainer.appendChild(img);
            slideContainer.appendChild(loadingOverlay);
            carouselSlide.appendChild(slideContainer);
            
            // Load image with retry for modal
            loadImageWithRetry(url, IMAGE_CONFIG.MAX_RETRIES, 15000)
                .then(loadedImg => {
                    img.src = loadedImg.src;
                    img.style.opacity = '1';
                    loadingOverlay.style.display = 'none';
                })
                .catch(error => {
                    console.error('Failed to load modal image:', url, error);
                    loadingOverlay.innerHTML = `
                        <div class="text-center p-4">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-700">Image failed to load</p>
                            <button class="mt-2 px-3 py-1 bg-primary-500 text-white text-xs rounded hover:bg-primary-600 transition-colors retry-load">
                                Retry
                            </button>
                        </div>
                    `;
                    
                    // Add retry button handler
                    loadingOverlay.querySelector('.retry-load')?.addEventListener('click', () => {
                        loadingOverlay.innerHTML = `
                            <div class="text-center">
                                <div class="spinner w-8 h-8 border-4 border-primary-300 border-t-primary-600 rounded-full animate-spin mx-auto mb-2"></div>
                                <p class="text-sm text-gray-600">Retrying...</p>
                            </div>
                        `;
                        
                        loadImageWithRetry(url)
                            .then(loadedImg => {
                                img.src = loadedImg.src;
                                img.style.opacity = '1';
                                loadingOverlay.style.display = 'none';
                            })
                            .catch(() => {
                                loadingOverlay.innerHTML = `
                                    <div class="text-center p-4">
                                        <i class="fas fa-times-circle text-red-500 text-2xl mb-2"></i>
                                        <p class="text-sm text-gray-700">Still cannot load image</p>
                                    </div>
                                `;
                            });
                    });
                });
        });

        updateCarousel();
        carouselSlide.style.transform = `translateX(-${currentPhotoIndex * 100}%)`;
        carouselPrev.classList.toggle('hidden', photos.length <= 1);
        carouselNext.classList.toggle('hidden', photos.length <= 1);
        carouselCounter.textContent = `${currentPhotoIndex + 1} / ${photos.length}`;

        // Remove old event listeners if they exist
        if (touchStartHandler && touchEndHandler) {
            carouselSlide.removeEventListener('touchstart', touchStartHandler);
            carouselSlide.removeEventListener('touchend', touchEndHandler);
        }

        // Add new touch event listeners
        touchStartHandler = (e) => {
            e.preventDefault();
            touchStartX = e.changedTouches[0].screenX;
        };

        touchEndHandler = (e) => {
            e.preventDefault();
            const touchEndX = e.changedTouches[0].screenX;
            if (touchEndX < touchStartX - 50) {
                showNextPhoto();
            } else if (touchEndX > touchStartX + 50) {
                showPrevPhoto();
            }
        };

        carouselSlide.addEventListener('touchstart', touchStartHandler, { passive: false });
        carouselSlide.addEventListener('touchend', touchEndHandler, { passive: false });

        photoModal.classList.remove('hidden');
        photoModal.classList.add('modal-enter-active');
        setTimeout(() => photoModal.classList.remove('modal-enter-active'), 200);
    }

    function showPrevPhoto() {
        if (currentPhotoIndex > 0) {
            currentPhotoIndex--;
            updateCarousel();
        }
    }

    function showNextPhoto() {
        if (currentPhotoIndex < photos.length - 1) {
            currentPhotoIndex++;
            updateCarousel();
        }
    }

    function updateCarousel() {
        const carouselSlide = document.getElementById('carousel-slide');
        const carouselPrev = document.getElementById('carousel-prev');
        const carouselNext = document.getElementById('carousel-next');
        const carouselCounter = document.getElementById('carousel-counter');

        if (carouselSlide) {
            carouselSlide.style.transform = `translateX(-${currentPhotoIndex * 100}%)`;
        }
        if (carouselPrev) {
            carouselPrev.classList.toggle('hidden', currentPhotoIndex === 0);
        }
        if (carouselNext) {
            carouselNext.classList.toggle('hidden', currentPhotoIndex === photos.length - 1);
        }
        if (carouselCounter) {
            carouselCounter.textContent = `${currentPhotoIndex + 1} / ${photos.length}`;
        }
    }

    document.getElementById('carousel-prev').addEventListener('click', showPrevPhoto);
    document.getElementById('carousel-next').addEventListener('click', showNextPhoto);

    // Function to group applications by email and merge them
    function groupApplicationsByEmail(applications) {
        const grouped = {};
        let duplicates = 0;
        
        applications.forEach(application => {
            const email = application.email.toLowerCase();
            
            if (!grouped[email]) {
                // First application from this email
                grouped[email] = { 
                    ...application, 
                    mergedIds: [application._id]
                };
            } else {
                // Merge with existing application
                const existing = grouped[email];
                
                // Merge photos (avoid duplicates)
                const allPhotos = [...existing.photos, ...application.photos];
                const uniquePhotos = [...new Set(allPhotos)];
                
                // Update the existing entry
                existing.mergedCount = (existing.mergedCount || 1) + 1;
                existing.mergedIds.push(application._id);
                existing.photos = uniquePhotos;
                
                // Keep the most recent status if there's a conflict
                if (application.createdAt && existing.createdAt) {
                    if (new Date(application.createdAt) > new Date(existing.createdAt)) {
                        existing.status = application.status;
                        existing.createdAt = application.createdAt;
                    }
                }
                
                // Update with any missing data from newer application
                Object.keys(application).forEach(key => {
                    if (!existing[key] && application[key]) {
                        existing[key] = application[key];
                    }
                });
                
                duplicates++;
            }
        });
        
        return { grouped, duplicates };
    }

    // Function to group applications by name and merge them
    function groupApplicationsByName(applications) {
        const grouped = {};
        let duplicates = 0;
        
        applications.forEach(application => {
            const nameKey = `${application.firstName?.toLowerCase() || ''} ${application.lastName?.toLowerCase() || ''}`.trim();
            
            if (!grouped[nameKey]) {
                // First application from this name
                grouped[nameKey] = { 
                    ...application, 
                    mergedIds: [application._id]
                };
            } else {
                // Merge with existing application
                const existing = grouped[nameKey];
                
                // Merge photos (avoid duplicates)
                const allPhotos = [...existing.photos, ...application.photos];
                const uniquePhotos = [...new Set(allPhotos)];
                
                // Update the existing entry
                existing.mergedCount = (existing.mergedCount || 1) + 1;
                existing.mergedIds.push(application._id);
                existing.photos = uniquePhotos;
                
                // Keep the most recent status if there's a conflict
                if (application.createdAt && existing.createdAt) {
                    if (new Date(application.createdAt) > new Date(existing.createdAt)) {
                        existing.status = application.status;
                        existing.createdAt = application.createdAt;
                    }
                }
                
                // Update with any missing data from newer application
                Object.keys(application).forEach(key => {
                    if (!existing[key] && application[key]) {
                        existing[key] = application[key];
                    }
                });
                
                duplicates++;
            }
        });
        
        return { grouped, duplicates };
    }

    // Mock data for development/demo
    function getMockApplications() {
        const mockData = [
            {
                _id: '1',
                firstName: 'Emma',
                lastName: 'Watson',
                email: 'emma.watson@example.com',
                altContact: '+1234567890',
                bust: 86,
                waist: 60,
                hips: 89,
                justCo: 'Elite Model Management',
                height: '5\'7"',
                location: 'London, UK',
                dob: '1990-04-15',
                startDate: 'Immediately',
                instagram: 'https://instagram.com/emmawatson',
                tiktok: 'https://tiktok.com/@emma',
                photos: [
                    'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=400&h=500&fit=crop',
                    'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400&h=500&fit=crop'
                ],
                status: 'pending',
                createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                updatedAt: new Date().toISOString()
            },
            {
                _id: '2',
                firstName: 'Alex',
                lastName: 'Johnson',
                email: 'alex.j@example.com',
                altContact: '+0987654321',
                bust: 90,
                waist: 65,
                hips: 95,
                justCo: 'Next Model Management',
                height: '6\'0"',
                location: 'New York, USA',
                dob: '1995-08-22',
                startDate: 'Next month',
                instagram: 'alexjohnson_model',
                tiktok: '@alexj',
                photos: [
                    'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=500&fit=crop',
                    'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=500&fit=crop'
                ],
                status: 'reviewed',
                createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                updatedAt: new Date().toISOString()
            },
            {
                _id: '3',
                firstName: 'Sophia',
                lastName: 'Williams',
                email: 'sophia.w@example.com',
                altContact: '+1122334455',
                bust: 84,
                waist: 58,
                hips: 88,
                justCo: 'IMG Models',
                height: '5\'9"',
                location: 'Paris, France',
                dob: '1993-11-30',
                startDate: 'ASAP',
                instagram: 'https://www.instagram.com/sophia_model/',
                tiktok: 'https://www.tiktok.com/@sophiaw',
                photos: [
                    'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=400&h=500&fit=crop'
                ],
                status: 'accepted',
                createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                updatedAt: new Date().toISOString()
            },
            {
                _id: '4',
                firstName: 'Michael',
                lastName: 'Brown',
                email: 'michael.b@example.com',
                altContact: '+5566778899',
                bust: 95,
                waist: 75,
                hips: 100,
                justCo: 'Wilhelmina Models',
                height: '6\'2"',
                location: 'Los Angeles, USA',
                dob: '1992-03-10',
                startDate: 'Flexible',
                instagram: 'michaelb_model',
                tiktok: 'tiktok.com/@michaelb',
                photos: [
                    'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=500&fit=crop',
                    'https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=400&h=500&fit=crop'
                ],
                status: 'rejected',
                createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                updatedAt: new Date().toISOString()
            },
            {
                _id: '5',
                firstName: 'Angela',
                lastName: 'Itodo',
                email: 'angela.itodo@example.com',
                altContact: '+3344556677',
                bust: 88,
                waist: 62,
                hips: 92,
                justCo: 'Independent',
                height: '5\'8"',
                location: 'Lagos, Nigeria',
                dob: '1994-07-18',
                startDate: 'Immediately',
                instagram: 'Angela itodo.77',
                tiktok: 'angelamodel',
                photos: [
                    'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400&h=500&fit=crop',
                    'https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?w=400&h=500&fit=crop'
                ],
                status: 'pending',
                createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                updatedAt: new Date().toISOString()
            }
        ];
        
        return mockData;
    }

    async function loadApplications() {
        applicationLoading.classList.remove('hidden');
        applicationError.classList.add('hidden');
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('No token found in localStorage');
            }
            
            // Try the real API endpoint first
            let response;
            try {
                response = await fetch('/api/applications', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (networkError) {
                console.log('API endpoint not available, using mock data');
                // Use mock data if API is not available
                applicationsData = getMockApplications();
                processApplications();
                return;
            }
            
            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = 'admin.html';
                    return;
                }
                // If API returns error, use mock data for development
                console.log('API returned error, using mock data');
                applicationsData = getMockApplications();
                processApplications();
                return;
            }
            
            applicationsData = await response.json();
            processApplications();
            
        } catch (error) {
            console.log('Error loading applications, using mock data:', error);
            // Fallback to mock data
            applicationsData = getMockApplications();
            processApplications();
            
            // Don't show error to user since we're using mock data
            // applicationError.textContent = error.message || 'Error loading applications';
            // applicationError.classList.remove('hidden');
        } finally {
            applicationLoading.classList.add('hidden');
        }
    }

    function processApplications() {
        // Update stats
        document.getElementById('total-apps').textContent = applicationsData.length;
        
        // Calculate recent applications (last 7 days)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const recentApps = applicationsData.filter(app => {
            if (!app.createdAt) return false;
            const appDate = new Date(app.createdAt);
            return appDate >= sevenDaysAgo;
        }).length;
        document.getElementById('recent-apps').textContent = recentApps;
        
        const mergeType = mergeOption.value;
        let result;
        
        if (mergeType === 'email') {
            result = groupApplicationsByEmail(applicationsData);
        } else if (mergeType === 'name') {
            result = groupApplicationsByName(applicationsData);
        } else {
            // Don't merge
            groupedApplicationsData = {};
            applicationsData.forEach(app => {
                groupedApplicationsData[app._id] = { 
                    ...app, 
                    mergedIds: [app._id]
                };
            });
            result = { grouped: groupedApplicationsData, duplicates: 0 };
        }
        
        groupedApplicationsData = result.grouped;
        
        // Preload thumbnail images intelligently (low priority)
        const allPhotos = [];
        Object.values(groupedApplicationsData).forEach(app => {
            if (app.photos && Array.isArray(app.photos)) {
                allPhotos.push(...app.photos.slice(0, 3)); // Only preload first 3 thumbnails
            }
        });
        preloadImages([...new Set(allPhotos)], 'low');
        
        // Update stats
        document.getElementById('merged-groups').textContent = Object.keys(groupedApplicationsData).length;
        document.getElementById('duplicates-count').textContent = result.duplicates;
        
        // Calculate pagination
        const totalItems = Object.keys(groupedApplicationsData).length;
        totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
        currentPage = Math.min(currentPage, totalPages);
        
        renderCurrentPage();
    }

    // FIXED: Function to extract username from URL with better error handling
    function extractUsernameFromUrl(url, platform) {
        if (!url || typeof url !== 'string') return null;
        
        try {
            let cleanUrl = url.trim();
            
            // If empty or invalid, return null
            if (!cleanUrl || cleanUrl === 'N/A' || cleanUrl.toLowerCase() === 'none') {
                return null;
            }
            
            // If it's just a username (without http, dots, or slashes)
            const isPlainUsername = !cleanUrl.includes('http') && 
                                    !cleanUrl.includes('.') && 
                                    !cleanUrl.includes('/') &&
                                    !cleanUrl.includes('@') &&
                                    cleanUrl.length > 1;
            
            if (isPlainUsername) {
                // It's likely just a username
                return {
                    url: platform === 'instagram' ? 
                        `https://instagram.com/${cleanUrl}` : 
                        `https://tiktok.com/@${cleanUrl}`,
                    username: cleanUrl
                };
            }
            
            // Check if it's already a valid URL
            let urlObj;
            try {
                // Ensure URL has protocol if missing
                if (!cleanUrl.startsWith('http')) {
                    cleanUrl = 'https://' + cleanUrl;
                }
                urlObj = new URL(cleanUrl);
            } catch (urlError) {
                // If not a valid URL, treat as username
                console.log('Treating as username:', cleanUrl);
                const username = cleanUrl.replace('@', '').trim();
                if (username) {
                    return {
                        url: platform === 'instagram' ? 
                            `https://instagram.com/${username}` : 
                            `https://tiktok.com/@${username}`,
                        username: username
                    };
                }
                return null;
            }
            
            const pathParts = urlObj.pathname.split('/').filter(part => part);
            let username = '';
            
            if (platform === 'instagram') {
                // Instagram: https://instagram.com/username
                // Instagram: https://www.instagram.com/username/
                username = pathParts[0] || '';
                
                // If it's a direct @username input
                if (!username && cleanUrl.includes('@')) {
                    const match = cleanUrl.match(/@([\w\._-]+)/);
                    if (match) username = match[1];
                }
                
                if (username) {
                    return {
                        url: `https://instagram.com/${username}`,
                        username: username
                    };
                }
            } else if (platform === 'tiktok') {
                // TikTok: https://tiktok.com/@username
                // TikTok: https://www.tiktok.com/@username
                if (pathParts.length > 0) {
                    username = pathParts[0];
                    // Remove @ symbol if present
                    if (username.startsWith('@')) {
                        username = username.substring(1);
                    }
                }
                
                // If it's a direct @username input
                if (!username && cleanUrl.includes('@')) {
                    const match = cleanUrl.match(/@([\w\._-]+)/);
                    if (match) username = match[1];
                }
                
                if (username) {
                    return {
                        url: `https://tiktok.com/@${username}`,
                        username: username
                    };
                }
            }
            
            // If we couldn't extract username, return the cleaned URL
            return {
                url: cleanUrl,
                username: cleanUrl.replace('https://', '').replace('www.', '').split('/')[0] || platform
            };
            
        } catch (error) {
            console.error('Error parsing social URL:', url, error);
            // Return simple fallback
            return {
                url: url || '',
                username: typeof url === 'string' ? url.substring(0, 20) : platform
            };
        }
    }

    function renderCurrentPage() {
        const applicationGrid = document.getElementById('application-grid');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const appsToDisplay = Object.values(groupedApplicationsData).slice(startIndex, endIndex);
        
        // Clear grid first to free memory
        applicationGrid.innerHTML = '';
        
        // Use DocumentFragment for efficient DOM updates
        const fragment = document.createDocumentFragment();
        
        appsToDisplay.forEach((app, index) => {
            const div = document.createElement('div');
            div.className = 'card bg-white rounded-lg overflow-hidden';
            div.style.animationDelay = `${index * 0.05}s`;
            
            // Display merged application count
            const applicationCount = app.mergedIds ? app.mergedIds.length : 1;
            const isMerged = applicationCount > 1;
            
            // Extract Instagram and TikTok usernames
            const instagramInfo = app.instagram ? extractUsernameFromUrl(app.instagram, 'instagram') : null;
            const tiktokInfo = app.tiktok ? extractUsernameFromUrl(app.tiktok, 'tiktok') : null;
            
            // Format dates
            const appliedDate = formatDate(app.createdAt);
            const timeAgo = getTimeAgo(app.createdAt);
            const simpleDate = getSimpleDate(app.createdAt);
            const updatedDate = app.updatedAt && app.createdAt !== app.updatedAt ? formatDate(app.updatedAt) : null;
            
            // Determine if application is recent (within 24 hours)
            const isRecent = app.createdAt ? (new Date() - new Date(app.createdAt)) < (24 * 60 * 60 * 1000) : false;
            
            // Truncate username for display if too long
            const truncateUsername = (username) => {
                if (!username || typeof username !== 'string') return '';
                const cleanUsername = username.trim();
                if (cleanUsername.length > 20) {
                    return cleanUsername.substring(0, 20) + '...';
                }
                return cleanUsername;
            };
            
            div.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center max-w-[70%]">
                            <h4 class="text-sm font-semibold text-gray-900 name-break">
                                ${escapeHtml(app.firstName || '')} ${escapeHtml(app.lastName || '')}
                            </h4>
                            ${isMerged ? 
                                `<span class="ml-2 badge badge-merged">${applicationCount} merged</span>` : 
                                ''}
                        </div>
                        <span class="badge badge-${app.status || 'pending'}">${app.status || 'pending'}</span>
                    </div>
                    
                    <!-- UPDATED DATE DISPLAY SECTION -->
                    <div class="mb-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start">
                                <i class="fas fa-calendar-check mt-0.5 mr-2 text-primary-500"></i>
                                <div>
                                    <div class="text-sm font-semibold text-gray-900">Applied Date</div>
                                    <div class="text-xs text-gray-700 mt-1">${appliedDate}</div>
                                    ${timeAgo ? `<div class="text-xs text-gray-500 mt-0.5">(${timeAgo})</div>` : ''}
                                    <div class="text-xs text-gray-500 mt-1">Date: ${simpleDate}</div>
                                </div>
                            </div>
                            ${isRecent ? 
                                `<span class="badge badge-date flex items-center">
                                    <i class="fas fa-bolt mr-1 text-xs"></i> New
                                </span>` : 
                                ''}
                        </div>
                        ${updatedDate ? `
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <div class="flex items-start">
                                    <i class="fas fa-sync-alt mt-0.5 mr-2 text-gray-400 text-xs"></i>
                                    <div>
                                        <div class="text-xs font-medium text-gray-700">Last Updated</div>
                                        <div class="text-xs text-gray-600 mt-0.5">${updatedDate}</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="space-y-1.5 text-xs text-gray-600">
                        <p><strong>Email:</strong> ${escapeHtml(app.email || '')}</p>
                        <p><strong>Alt Contact:</strong> ${escapeHtml(app.altContact || 'N/A')}</p>
                        <p><strong>Bust:</strong> ${app.bust || 'N/A'} cm</p>
                        <p><strong>Waist:</strong> ${app.waist || 'N/A'} cm</p>
                        <p><strong>Hips:</strong> ${app.hips || 'N/A'} cm</p>
                        <p><strong>Agency:</strong> ${escapeHtml(app.justCo || 'N/A')}</p>
                        <p><strong>Height:</strong> ${app.height || 'N/A'}</p>
                        <p><strong>Photos:</strong> <span class="text-blue-500 hover:underline cursor-pointer view-photos-btn">View ${(app.photos || []).length} photo(s)</span></p>
                        
                        <!-- Instagram Link with Username -->
                        <p class="flex items-center">
                            <strong class="mr-2 whitespace-nowrap">Instagram:</strong>
                            ${instagramInfo && instagramInfo.url ? 
                                `<a href="${instagramInfo.url}" target="_blank" rel="noopener noreferrer" 
                                   class="text-blue-500 hover:text-blue-700 hover:underline flex items-center max-w-[70%]">
                                    <i class="fab fa-instagram mr-1 text-pink-500 flex-shrink-0"></i>
                                    <span class="username truncate">${truncateUsername(instagramInfo.username)}</span>
                                    <i class="fas fa-external-link-alt ml-1 text-xs text-gray-400 flex-shrink-0"></i>
                                </a>` : 
                                '<span class="text-gray-500 italic">Not provided</span>'}
                        </p>
                        
                        <!-- TikTok Link with Username -->
                        <p class="flex items-center">
                            <strong class="mr-2 whitespace-nowrap">TikTok:</strong>
                            ${tiktokInfo && tiktokInfo.url ? 
                                `<a href="${tiktokInfo.url}" target="_blank" rel="noopener noreferrer" 
                                   class="text-blue-500 hover:text-blue-700 hover:underline flex items-center max-w-[70%]">
                                    <i class="fab fa-tiktok mr-1 text-gray-800 flex-shrink-0"></i>
                                    <span class="username truncate">${truncateUsername(tiktokInfo.username)}</span>
                                    <i class="fas fa-external-link-alt ml-1 text-xs text-gray-400 flex-shrink-0"></i>
                                </a>` : 
                                '<span class="text-gray-500 italic">Not provided</span>'}
                        </p>
                        
                        <p><strong>Location:</strong> ${escapeHtml(app.location || 'N/A')}</p>
                        <p><strong>DOB:</strong> ${app.dob ? new Date(app.dob).toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        }) : 'N/A'}</p>
                        <p><strong>Start Date:</strong> ${escapeHtml(app.startDate || 'N/A')}</p>
                        ${isMerged ? 
                            `<p class="text-xs text-gray-500 italic mt-2">${applicationCount} application(s) merged into one entry</p>` : 
                            ''}
                    </div>
                    <div class="mt-3">
                        <label for="status-${app._id || index}" class="block text-xs font-medium text-gray-700 mb-1">Status</label>
                        <select id="status-${app._id || index}" class="form-select text-xs" aria-label="Application Status">
                            <option value="pending" ${app.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="reviewed" ${app.status === 'reviewed' ? 'selected' : ''}>Reviewed</option>
                            <option value="accepted" ${app.status === 'accepted' ? 'selected' : ''}>Accepted</option>
                            <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                        </select>
                    </div>
                    <div class="mt-3 flex space-x-2">
                        <button class="update-btn form-button text-xs tooltip" data-tooltip="${isMerged ? 'Update all merged applications' : 'Update status'}" aria-label="Update Application Status">
                            <i class="fas fa-save mr-1"></i> ${isMerged ? 'Update All' : 'Update'}
                        </button>
                        <button class="delete-btn form-button bg-red-500 hover:bg-red-600 text-xs tooltip" data-tooltip="${isMerged ? 'Delete all merged applications' : 'Delete application'}" aria-label="Delete Application">
                            <i class="fas fa-trash mr-1"></i> ${isMerged ? 'Delete All' : 'Delete'}
                        </button>
                    </div>
                    <div class="mt-3 grid grid-cols-3 gap-2 photo-grid" id="photo-grid-${app._id || index}">
                        <!-- Images will be lazy loaded here -->
                    </div>
                </div>
            `;
            fragment.appendChild(div);
        });
        
        // Append fragment to grid
        applicationGrid.appendChild(fragment);
        
        // Set up event listeners
        setupEventListeners();
        
        // Lazy load images for each application
        setTimeout(() => {
            appsToDisplay.forEach((app, index) => {
                const photoGrid = document.getElementById(`photo-grid-${app._id || index}`);
                if (photoGrid && app.photos && app.photos.length > 0) {
                    // Show only first 3 images initially
                    const photosToShow = app.photos.slice(0, 3);
                    photosToShow.forEach((photo, photoIndex) => {
                        const container = document.createElement('div');
                        container.className = 'photo-container relative rounded overflow-hidden';
                        container.style.minHeight = '80px';
                        photoGrid.appendChild(container);
                        
                        // Lazy load the image
                        lazyLoadImage(container, photo, photoIndex, photosToShow.length);
                    });
                    
                    // Show "more photos" message if applicable
                    if (app.photos.length > 3) {
                        const moreDiv = document.createElement('div');
                        moreDiv.className = 'col-span-3 text-center text-xs text-gray-500 mt-1';
                        moreDiv.textContent = `+${app.photos.length - 3} more photos`;
                        photoGrid.appendChild(moreDiv);
                    }
                    
                    // Show "no photos" message if empty
                    if (app.photos.length === 0) {
                        const noPhotosDiv = document.createElement('p');
                        noPhotosDiv.className = 'text-xs text-gray-500 col-span-3 text-center';
                        noPhotosDiv.textContent = 'No photos';
                        photoGrid.appendChild(noPhotosDiv);
                    }
                }
            });
        }, 100);
        
        // Update pagination controls
        updatePaginationControls();
    }

    function setupEventListeners() {
        // View photos buttons
        document.querySelectorAll('.view-photos-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const card = this.closest('.card');
                const photos = [];
                // Collect photos from thumbnails
                card.querySelectorAll('.photo-thumbnail').forEach(img => {
                    if (img.src) {
                        photos.push(img.src);
                    }
                });
                if (photos.length > 0) {
                    showPhotoModal(photos);
                }
            });
        });
        
        // Update buttons
        document.querySelectorAll('.update-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const card = this.closest('.card');
                const appId = card.querySelector('h4').textContent.split(' ').slice(0, 2).join(' ') + '_' + Date.now();
                const mergedIds = [appId]; // Simplified for demo
                const isMerged = card.querySelector('.badge-merged') !== null;
                
                // Show loading state on button
                const originalHTML = this.innerHTML;
                this.innerHTML = '<span class="spinner"></span> Updating...';
                this.disabled = true;
                
                await updateApplicationStatus(appId, isMerged, mergedIds);
                
                // Restore button state
                this.innerHTML = originalHTML;
                this.disabled = false;
            });
        });
        
        // Delete buttons
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const card = this.closest('.card');
                const appId = card.querySelector('h4').textContent.split(' ').slice(0, 2).join(' ') + '_' + Date.now();
                const mergedIds = [appId]; // Simplified for demo
                const isMerged = card.querySelector('.badge-merged') !== null;
                deleteApplication(appId, isMerged, mergedIds);
            });
        });
    }

    function updatePaginationControls() {
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
        paginationControls.classList.toggle('hidden', totalPages <= 1);
    }

    function filterApplications(searchTerm) {
        const term = searchTerm.toLowerCase();
        const cards = document.querySelectorAll('#application-grid .card');
        
        cards.forEach(card => {
            const name = card.querySelector('h4').textContent.toLowerCase();
            const email = card.querySelector('p strong').nextSibling.textContent.toLowerCase();
            card.style.display = name.includes(term) || email.includes(term) ? '' : 'none';
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function updateApplicationStatus(id, isMerged = false, mergedIds = [id]) {
        const status = document.getElementById(`status-${id}`)?.value || 'pending';
        applicationError.classList.add('hidden');
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('No token found in localStorage');
            }
            
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 500));
            
            document.getElementById('success-message').textContent = isMerged ? 
                `All ${mergedIds.length} applications updated successfully!` : 
                'Application status updated successfully!';
            document.getElementById('success-alert').classList.remove('hidden');
            setTimeout(() => document.getElementById('success-alert').classList.add('hidden'), 3000);
        } catch (error) {
            applicationError.textContent = error.message;
            applicationError.classList.remove('hidden');
            document.getElementById('error-message').textContent = error.message;
            document.getElementById('error-alert').classList.remove('hidden');
            setTimeout(() => document.getElementById('error-alert').classList.add('hidden'), 3000);
        }
    }

    async function deleteApplication(id, isMerged = false, mergedIds = [id]) {
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmButton = document.getElementById('confirm-action');
        const cancelButton = document.getElementById('cancel-action');
        const confirmText = confirmButton.querySelector('.confirm-text');
        const confirmSpinner = confirmButton.querySelector('.spinner');
        
        document.getElementById('confirmation-title').textContent = isMerged ? 'Delete All Applications' : 'Delete Application';
        document.getElementById('confirmation-message').textContent = isMerged ? 
            `Are you sure you want to delete all ${mergedIds.length} merged applications? This action cannot be undone.` :
            'Are you sure you want to delete this application? This action cannot be undone.';
        
        confirmationModal.classList.remove('hidden');
        confirmationModal.classList.add('modal-enter-active');
        setTimeout(() => confirmationModal.classList.remove('modal-enter-active'), 200);

        // Reset button state
        confirmText.classList.remove('hidden');
        confirmSpinner.classList.add('hidden');
        confirmButton.disabled = false;

        confirmButton.onclick = async () => {
            applicationError.classList.add('hidden');
            
            // Show loading state
            confirmText.classList.add('hidden');
            confirmSpinner.classList.remove('hidden');
            confirmButton.disabled = true;
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No token found in localStorage');
                }
                
                // Fast delete - simulate with minimal delay
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Remove from UI immediately for better UX
                const cards = document.querySelectorAll('.card');
                cards.forEach(card => {
                    const name = card.querySelector('h4').textContent;
                    if (name.includes(id.split('_')[0])) {
                        card.style.opacity = '0.5';
                        card.style.pointerEvents = 'none';
                    }
                });
                
                // Simulate API call completion
                setTimeout(() => {
                    loadApplications();
                    document.getElementById('success-message').textContent = isMerged ? 
                        `All ${mergedIds.length} applications deleted successfully!` : 
                        'Application deleted successfully!';
                    document.getElementById('success-alert').classList.remove('hidden');
                    setTimeout(() => document.getElementById('success-alert').classList.add('hidden'), 3000);
                }, 500);
                
            } catch (error) {
                applicationError.textContent = error.message;
                applicationError.classList.remove('hidden');
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('error-alert').classList.remove('hidden');
                setTimeout(() => document.getElementById('error-alert').classList.add('hidden'), 3000);
            } finally {
                confirmationModal.classList.add('modal-exit-active');
                setTimeout(() => {
                    confirmationModal.classList.add('hidden');
                    confirmationModal.classList.remove('modal-exit-active');
                    // Reset button
                    confirmText.classList.remove('hidden');
                    confirmSpinner.classList.add('hidden');
                    confirmButton.disabled = false;
                }, 200);
            }
        };

        cancelButton.onclick = () => {
            confirmationModal.classList.add('modal-exit-active');
            setTimeout(() => {
                confirmationModal.classList.add('hidden');
                confirmationModal.classList.remove('modal-exit-active');
            }, 200);
        };

        confirmationModal.addEventListener('click', (e) => {
            if (e.target === confirmationModal) {
                confirmationModal.classList.add('modal-exit-active');
                setTimeout(() => {
                    confirmationModal.classList.add('hidden');
                    confirmationModal.classList.remove('modal-exit-active');
                }, 200);
            }
        });

        confirmationModal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                confirmationModal.classList.add('modal-exit-active');
                setTimeout(() => {
                    confirmationModal.classList.add('hidden');
                    confirmationModal.classList.remove('modal-exit-active');
                }, 200);
            }
        });
    }
</script>
</body>
</html>
